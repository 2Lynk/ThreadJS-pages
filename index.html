<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ThreadJS API Reference</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">

  <style>
    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --panel: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      --text-primary: #1a1d20;
      --text-secondary: #495057;
      --border-light: #dee2e6;
      --border-medium: #adb5bd;
      --accent: #6c757d;
      --accent-hover: #495057;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);

      --code-bg: #212529;
      --code-border: #343a40;
      --code-text: #f8f9fa;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Version bar under header */
    .version-bar {
      padding: 0.5rem 2rem;
      background: #f1f3f5;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .version-bar label {
      font-weight: 500;
    }

    .version-select {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      border: 1px solid var(--border-medium);
      background: var(--bg-secondary);
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .version-note {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    main {
      height: calc(100vh - 120px); /* header + version bar */
      display: flex;
      padding: 0;
    }

    #sidebar {
      width: 220px;
      background: #f8f9fa;
      border-right: 1px solid var(--border-light);
      padding: 1rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #sidebar h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin: 0 0 0.5rem;
    }

    #tag-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    #tag-list > li {
      margin: 0;
      border-radius: 10px;
      padding: 0.1rem 0.2rem;
    }

    #tag-list > li.active-tag {
      background: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .tag-link {
      display: block;
      padding: 0.32rem 0.65rem;
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }

    .tag-link:hover {
      background: #e9ecef;
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    #tag-list > li.active-tag > .tag-link {
      background: transparent;
      color: #ffffff;
      font-weight: 600;
    }

    /* Nested function list under each module */
    .tag-func-list {
      list-style: none;
      margin: 0.35rem 0 0.1rem;
      padding: 0;
      display: none;
      flex-direction: column;
      gap: 0.2rem;
    }

    #tag-list li.active-tag .tag-func-list {
      display: flex;
    }

    .tag-func-list li {
      margin: 0;
    }

    .tag-func-link {
      width: 100%;
      text-align: left;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      padding: 0.25rem 0.5rem;
      background: #ffffff;
      font-size: 0.82rem;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.1s ease;
      display: block;
      text-decoration: none;
    }

    .tag-func-link:hover {
      background: #f1f3f5;
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    #content-panel {
      flex: 1;
      background: var(--bg-secondary);
      padding: 1.25rem 1.75rem 1.75rem;
      overflow-y: auto;
    }

    #intro {
      max-width: 760px;
      margin-bottom: 1.25rem;
      color: var(--text-secondary);
    }

    #intro h1, #intro h2, #intro h3 {
      color: var(--text-primary);
    }

    .tag-section {
      margin-bottom: 2rem;
    }

    .tag-section h2 {
      margin: 0 0 0.75rem;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 0.25rem;
    }

    .function-card {
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: #ffffff;
      padding: 0.9rem 1rem;
      margin-bottom: 0.85rem;
      box-shadow: var(--shadow-sm);
    }

    .function-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .function-name {
      font-weight: 600;
      font-size: 0.98rem;
      word-break: break-word;
    }

    .function-tag-label {
      font-size: 0.75rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #e9ecef;
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
      white-space: nowrap;
    }

    .function-body {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .func-description {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .func-description p {
      margin: 0 0 0.4rem;
    }

    .func-samples {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .func-samples-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .sample-block {
      border-radius: 8px;
      border: 1px solid var(--code-border);
      background: var(--code-bg);
      padding: 0.45rem 0.55rem 0.55rem;
    }

    .sample-label {
      font-size: 0.78rem;
      color: #ced4da;
      margin-bottom: 0.2rem;
    }

    .sample-block pre {
      margin: 0;
      white-space: pre;
      overflow-x: auto;
      font-family: "Fira Code", "Courier New", monospace;
      font-size: 0.8rem;
      color: var(--code-text);
      background: transparent;
      border: none;
    }

    .sample-block code {
      background: transparent;
      color: inherit;
    }

    .loading-msg,
    .error-msg {
      padding: 0.75rem 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #fff3cd;
      color: #856404;
      font-size: 0.9rem;
      max-width: 640px;
    }

    .error-msg {
      background: #fdecea;
      color: #b91c1c;
    }

    /* Scrollbars */
    #sidebar::-webkit-scrollbar,
    #content-panel::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    #sidebar::-webkit-scrollbar-track,
    #content-panel::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    #sidebar::-webkit-scrollbar-thumb,
    #content-panel::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 5px;
    }
    #sidebar::-webkit-scrollbar-thumb:hover,
    #content-panel::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }

      nav {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }

      nav a {
        flex: 1;
        text-align: center;
        padding: 0.5rem 0.8rem;
        font-size: 0.875rem;
      }

      .version-bar {
        padding: 0.5rem 1rem;
        flex-direction: column;
        align-items: flex-start;
      }

      main {
        height: calc(100vh - 150px);
      }

      #sidebar {
        display: none; /* simpler: content only on mobile */
      }
    }
  </style>

  <!-- YAML & Markdown parsers -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- version helper -->
  <script src="version.js"></script>
</head>
<body class="app-layout">
  <header>
    <div class="header-inner">
      <!-- Left: ThreadJS brand + Lynk link -->
      <div style="display:flex; align-items:center; gap:0.75rem;">
        <a href="../" class="brand">
          <div class="brand-mark">T</div>
          <div class="brand-labels">
            <div class="brand-text-main">ThreadJS</div>
            <div class="brand-text-sub">Minecraft JS scripting</div>
          </div>
        </a>

        <!-- Back to main homepage -->
        <a class="nav-pill" href="https://2lynk.github.io/">Lynk</a>
      </div>

      <!-- Right: ThreadJS section navigation -->
      <nav class="nav-links">
        <a class="nav-pill nav-pill--accent" href="index.html">API Reference</a>
        <a class="nav-pill" href="inspector.html">Inspector</a>
        <a class="nav-pill" href="example-mods.html">Example Mods</a>
        <a class="nav-pill" href="designer.html">Designer (BETA)</a>
        <a class="nav-pill" href="variable-reference.html">Variables</a>
      </nav>
    </div>
  </header>

  <div class="version-bar">
    <label for="versionSelectApi">Version:</label>
    <select id="versionSelectApi" class="version-select"></select>
    <span id="versionNoteApi" class="version-note"></span>
  </div>

  <main>
    <aside id="sidebar">
      <h2>Modules</h2>
      <ul id="tag-list"></ul>
    </aside>

    <section id="content-panel">
      <div id="intro" class="intro"></div>
      <div id="sections"></div>
    </section>
  </main>

  <script>
    const tagListEl = document.getElementById("tag-list");
    const sectionsEl = document.getElementById("sections");
    const introEl = document.getElementById("intro");
    const contentPanel = document.getElementById("content-panel");

    const tagLinksByName = {};
    const sectionEls = [];
    let tagsGlobal = [];
    let scrollListenerBound = false;

    function scrollToSectionId(id) {
      const el = document.getElementById(id);
      if (!el || !contentPanel) return;
      const contentRect = contentPanel.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      const offset = elRect.top - contentRect.top + contentPanel.scrollTop - 10;
      contentPanel.scrollTo({ top: offset, behavior: "smooth" });
    }

    function setActiveTag(tagName) {
      Object.keys(tagLinksByName).forEach(tag => {
        const li = tagLinksByName[tag].parentElement;
        if (tag === tagName) {
          li.classList.add("active-tag");
        } else {
          li.classList.remove("active-tag");
        }
      });
    }

    function renderFromSpec(spec) {
      // Intro text from spec.info.description
      if (spec.info && spec.info.description) {
        introEl.innerHTML = marked.parse(spec.info.description);
      } else {
        introEl.textContent =
          "ThreadJS lets you write Minecraft server mods in JavaScript. This page documents the scripting API.";
      }

      const tags = (spec.tags || []).map(t => t.name);
      tagsGlobal = tags;

      const operationsByTag = {};
      const paths = spec.paths || {};

      for (const path in paths) {
        if (!Object.prototype.hasOwnProperty.call(paths, path)) continue;

        const pathObj = paths[path];
        // We intentionally ignore HTTP verbs now; treat each path object as a "function" block
        const op = pathObj;
        if (!op || !op.tags) continue;

        op.tags.forEach(tag => {
          if (!operationsByTag[tag]) operationsByTag[tag] = [];
          operationsByTag[tag].push({
            summary: op.summary || path,
            description: op.description || "",
            samples: op["x-codeSamples"] || []
          });
        });
      }

      // Build sidebar tag list with nested functions
      tagListEl.innerHTML = "";
      Object.keys(tagLinksByName).forEach(k => delete tagLinksByName[k]);

      tags.forEach((tag, idx) => {
        const li = document.createElement("li");
        if (idx === 0) li.classList.add("active-tag");
        
        const a = document.createElement("a");
        a.className = "tag-link";
        a.textContent = tag;
        a.href = "javascript:void(0)";
        tagLinksByName[tag] = a;
        a.onclick = () => {
          scrollToSectionId("tag-" + tag);
          setActiveTag(tag);
        };
        li.appendChild(a);

        // Add nested function list
        const funcs = operationsByTag[tag] || [];
        if (funcs.length > 0) {
          const funcList = document.createElement("ul");
          funcList.className = "tag-func-list";

          funcs.forEach(func => {
            const funcLi = document.createElement("li");
            const funcLink = document.createElement("a");
            funcLink.className = "tag-func-link";
            funcLink.textContent = func.summary;
            funcLink.href = "javascript:void(0)";
            funcLink.title = func.summary;
            funcLink.onclick = (e) => {
              e.stopPropagation();
              scrollToSectionId("func-" + tag + "-" + func.summary.replace(/[^a-zA-Z0-9]/g, "-"));
              setActiveTag(tag);
            };
            funcLi.appendChild(funcLink);
            funcList.appendChild(funcLi);
          });

          li.appendChild(funcList);
        }

        tagListEl.appendChild(li);
      });

      // Build content sections
      sectionsEl.innerHTML = "";
      sectionEls.length = 0;

      tags.forEach(tag => {
        const funcs = operationsByTag[tag] || [];
        if (funcs.length === 0) return;

        const section = document.createElement("section");
        section.className = "tag-section";
        section.id = "tag-" + tag;
        section.dataset.tag = tag;

        const h2 = document.createElement("h2");
        h2.textContent = tag;
        section.appendChild(h2);

        funcs.forEach(func => {
          const card = document.createElement("article");
          card.className = "function-card";
          card.id = "func-" + tag + "-" + func.summary.replace(/[^a-zA-Z0-9]/g, "-");

          const header = document.createElement("div");
          header.className = "function-header";

          const nameEl = document.createElement("div");
          nameEl.className = "function-name";
          nameEl.textContent = func.summary;

          const tagLabel = document.createElement("div");
          tagLabel.className = "function-tag-label";
          tagLabel.textContent = tag;

          header.appendChild(nameEl);
          header.appendChild(tagLabel);
          card.appendChild(header);

          const body = document.createElement("div");
          body.className = "function-body";

          const desc = document.createElement("div");
          desc.className = "func-description";
          if (func.description) {
            desc.innerHTML = marked.parse(func.description);
          } else {
            desc.textContent = "No description yet.";
          }

          const samples = document.createElement("div");
          samples.className = "func-samples";

          if (func.samples && func.samples.length > 0) {
            const title = document.createElement("div");
            title.className = "func-samples-title";
            title.textContent = "Examples";
            samples.appendChild(title);

            func.samples.forEach(sample => {
              const block = document.createElement("div");
              block.className = "sample-block";

              const label = document.createElement("div");
              label.className = "sample-label";
              label.textContent =
                (sample.label || sample.lang || "Example") +
                (sample.lang ? " — " + sample.lang : "");
              block.appendChild(label);

              const pre = document.createElement("pre");
              const code = document.createElement("code");
              code.textContent = sample.source || "";
              pre.appendChild(code);
              block.appendChild(pre);

              samples.appendChild(block);
            });
          }

          body.appendChild(desc);
          body.appendChild(samples);
          card.appendChild(body);
          section.appendChild(card);
        });

        sectionsEl.appendChild(section);
        sectionEls.push(section);
      });

      if (!sectionsEl.innerHTML.trim()) {
        sectionsEl.innerHTML =
          '<div class="loading-msg">No functions found in the spec.</div>';
      }

      // Scroll to first tag by default
      if (tags.length > 0) {
        scrollToSectionId("tag-" + tags[0]);
        setActiveTag(tags[0]);
      }

      // Update active tag while scrolling (bind once)
      if (!scrollListenerBound) {
        scrollListenerBound = true;
        contentPanel.addEventListener("scroll", () => {
          if (sectionEls.length === 0) return;

          const containerRect = contentPanel.getBoundingClientRect();
          const threshold = 40;

          let bestTag = tagsGlobal[0];
          let bestDelta = Infinity;

          sectionEls.forEach(sec => {
            const rect = sec.getBoundingClientRect();
            const delta = rect.top - containerRect.top;

            if (delta <= threshold && Math.abs(delta) < bestDelta) {
              bestDelta = Math.abs(delta);
              bestTag = sec.dataset.tag;
            }
          });

          if (bestTag) setActiveTag(bestTag);
        });
      }
    }

    function loadSpecFromUrl(specUrl) {
      introEl.innerHTML = "";
      sectionsEl.innerHTML =
        '<div class="loading-msg">Loading <code>' + specUrl + "</code>…</div>";

      fetch(specUrl)
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.text();
        })
        .then(text => {
          const spec = jsyaml.load(text);
          renderFromSpec(spec);
        })
        .catch(err => {
          introEl.innerHTML = "";
          sectionsEl.innerHTML =
            '<div class="error-msg">Failed to load <code>' +
            specUrl +
            "</code>: " +
            String(err) +
            "</div>";
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const selectId = "versionSelectApi";
      const noteId = "versionNoteApi";

      if (window.ThreadJsVersion && window.ThreadJsVersion.initSelector) {
        ThreadJsVersion.initSelector({
          selectId,
          noteId,
          filePattern: /^v[\d.]+\.(yaml|yml)$/,  // Only API specs, not -variables files
          onReady(entry) {
            loadSpecFromUrl(entry.yamlPath);
          },
          onChange(entry) {
            loadSpecFromUrl(entry.yamlPath);
          }
        });
      } else {
        const noteEl = document.getElementById(noteId);
        if (noteEl) {
          noteEl.textContent = "Version system not available – using openapi.yaml";
        }
        loadSpecFromUrl("openapi.yaml");
      }
    });
  </script>
</body>
</html>
