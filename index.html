<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ThreadJS API Reference</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">

  <!-- YAML & Markdown parsers -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Version helper -->
  <script src="version.js"></script>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- Left: ThreadJS brand + link back to Lynk homepage -->
      <div style="display:flex; align-items:center; gap:0.75rem;">
        <a href="../" class="brand">
          <div class="brand-mark">T</div>
          <div class="brand-labels">
            <div class="brand-text-main">ThreadJS</div>
            <div class="brand-text-sub">Minecraft JS scripting</div>
          </div>
        </a>
        <a class="nav-pill" href="https://2lynk.github.io/">Lynk</a>
      </div>

      <!-- Right: ThreadJS section navigation -->
      <nav class="nav-links">
        <a class="nav-pill nav-pill--accent" href="index.html">API Reference</a>
        <a class="nav-pill" href="inspector.html">Inspector</a>
        <a class="nav-pill" href="example-mods.html">Example mods</a>
        <a class="nav-pill" href="designer.html">Designer</a>
        <a class="nav-pill" href="variable-reference.html">Variables</a>
      </nav>
    </div>
  </header>

  <div class="version-bar">
    <label for="versionSelectApi">Version:</label>
    <select id="versionSelectApi" class="version-select"></select>
    <span id="versionNoteApi" class="version-note"></span>
  </div>

  <main>
    <aside id="sidebar">
      <h2>Modules</h2>
      <ul id="tag-list"></ul>
    </aside>

    <section id="content-panel">
      <div id="intro" class="intro"></div>
      <div id="sections"></div>
    </section>
  </main>

  <script>
    const tagListEl = document.getElementById("tag-list");
    const sectionsEl = document.getElementById("sections");
    const introEl = document.getElementById("intro");
    const contentPanel = document.getElementById("content-panel");

    const tagLinksByName = {};
    const tagLisByName = {};
    const sectionEls = [];
    let tagsGlobal = [];

    function scrollToSectionId(id) {
      const el = document.getElementById(id);
      if (!el || !contentPanel) return;
      const contentRect = contentPanel.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      const offset =
        elRect.top - contentRect.top + contentPanel.scrollTop - 10;
      contentPanel.scrollTo({ top: offset, behavior: "smooth" });
    }

    function setActiveTag(tagName) {
      Object.values(tagLinksByName).forEach((link) =>
        link.classList.remove("active")
      );
      Object.values(tagLisByName).forEach((li) =>
        li.classList.remove("active-tag")
      );

      const link = tagLinksByName[tagName];
      const li = tagLisByName[tagName];

      if (link) link.classList.add("active");
      if (li) li.classList.add("active-tag");
    }

    // Turn a summary into a safe DOM id
    function makeDomId(tag, summary) {
      const safeSummary = String(summary || "")
        .toLowerCase()
        .replace(/[^\w]+/g, "-")
        .replace(/^-+|-+$/g, "");
      return "func-" + tag.toLowerCase() + "-" + safeSummary;
    }

    function showLoading(message) {
      sectionsEl.innerHTML =
        '<div class="loading-msg">' +
        (message || "Loading API spec…") +
        "</div>";
    }

    function showError(message) {
      sectionsEl.innerHTML =
        '<div class="error-msg">' +
        (message || "Failed to load API spec.") +
        "</div>";
    }

    function renderOpenApiFromText(yamlText) {
      let spec;
      try {
        spec = jsyaml.load(yamlText);
      } catch (err) {
        console.error("YAML parse error:", err);
        introEl.innerHTML = "";
        showError("Could not parse YAML: " + String(err));
        return;
      }

      // Intro from info.description
      if (spec.info && spec.info.description) {
        introEl.innerHTML = marked.parse(spec.info.description);
      } else {
        introEl.textContent =
          "ThreadJS lets you write Minecraft server mods in JavaScript. This page documents the scripting API.";
      }

      const tags = (spec.tags || []).map((t) => t.name);
      tagsGlobal = tags;

      // Collect operations per tag
      const operationsByTag = {};
      const paths = spec.paths || {};

      for (const path in paths) {
        if (!Object.prototype.hasOwnProperty.call(paths, path)) continue;
        const op = paths[path];
        if (!op || !op.tags) continue;

        const opSummary = op.summary || path;
        const description = op.description || "";
        const samples = op["x-codeSamples"] || [];

        op.tags.forEach((tag) => {
          if (!operationsByTag[tag]) operationsByTag[tag] = [];
          operationsByTag[tag].push({
            path,
            tag,
            summary: opSummary,
            description,
            samples,
          });
        });
      }

      // Attach DOM ids for deep-linking
      Object.keys(operationsByTag).forEach((tag) => {
        operationsByTag[tag].forEach((func) => {
          func.domId = makeDomId(tag, func.summary);
        });
      });

      // Sidebar: modules + nested function list
      tagListEl.innerHTML = "";
      Object.keys(tagLinksByName).forEach((k) => delete tagLinksByName[k]);
      Object.keys(tagLisByName).forEach((k) => delete tagLisByName[k]);

      tags.forEach((tag, idx) => {
        const funcs = operationsByTag[tag] || [];

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.className = "tag-link" + (idx === 0 ? " active" : "");
        a.textContent = tag;
        a.href = "javascript:void(0)";
        tagLinksByName[tag] = a;
        tagLisByName[tag] = li;

        a.onclick = () => {
          scrollToSectionId("tag-" + tag);
          setActiveTag(tag);
        };

        li.appendChild(a);

        // Nested functions for this module
        if (funcs.length > 0) {
          const funcList = document.createElement("ul");
          funcList.className = "tag-func-list";

          funcs.forEach((func) => {
            const fi = document.createElement("li");
            const fa = document.createElement("button");
            fa.className = "tag-func-link";
            fa.type = "button";
            // Summary already has nice names, e.g. "api.log(message)"
            fa.textContent = func.summary;
            fa.onclick = () => {
              scrollToSectionId(func.domId);
              setActiveTag(tag);
            };
            fi.appendChild(fa);
            funcList.appendChild(fi);
          });

          li.appendChild(funcList);
        }

        tagListEl.appendChild(li);

        if (idx === 0) {
          li.classList.add("active-tag");
        }
      });

      // Content sections
      sectionsEl.innerHTML = "";
      sectionEls.length = 0;

      tags.forEach((tag) => {
        const funcs = operationsByTag[tag] || [];
        if (funcs.length === 0) return;

        const section = document.createElement("section");
        section.className = "tag-section";
        section.id = "tag-" + tag;
        section.dataset.tag = tag;

        const h2 = document.createElement("h2");
        h2.textContent = tag;
        section.appendChild(h2);

        funcs.forEach((func) => {
          const card = document.createElement("article");
          card.className = "function-card";
          card.id = func.domId;

          const header = document.createElement("div");
          header.className = "function-header";

          const nameEl = document.createElement("div");
          nameEl.className = "function-name";
          nameEl.textContent = func.summary;

          const tagLabel = document.createElement("div");
          tagLabel.className = "function-tag-label";
          tagLabel.textContent = tag;

          header.appendChild(nameEl);
          header.appendChild(tagLabel);
          card.appendChild(header);

          const body = document.createElement("div");
          body.className = "function-body";

          const desc = document.createElement("div");
          desc.className = "func-description";

          if (func.description) {
            desc.innerHTML = marked.parse(func.description);
          } else {
            desc.textContent = "No description yet.";
          }

          const samples = document.createElement("div");
          samples.className = "func-samples";

          if (func.samples && func.samples.length > 0) {
            const title = document.createElement("div");
            title.className = "func-samples-title";
            title.textContent = "Examples";
            samples.appendChild(title);

            func.samples.forEach((sample) => {
              const block = document.createElement("div");
              block.className = "sample-block";

              const label = document.createElement("div");
              label.className = "sample-label";
              label.textContent =
                (sample.label || sample.lang || "Example") +
                (sample.lang ? " — " + sample.lang : "");
              block.appendChild(label);

              const pre = document.createElement("pre");
              const code = document.createElement("code");
              code.textContent = sample.source || "";
              pre.appendChild(code);
              block.appendChild(pre);

              samples.appendChild(block);
            });
          }

          body.appendChild(desc);
          body.appendChild(samples);
          card.appendChild(body);
          section.appendChild(card);
        });

        sectionsEl.appendChild(section);
        sectionEls.push(section);
      });

      if (!sectionsEl.innerHTML.trim()) {
        showError("No functions found in this spec.");
      }

      // Scroll to first tag by default
      if (tags.length > 0) {
        scrollToSectionId("tag-" + tags[0]);
        setActiveTag(tags[0]);
      }

      // Update active tag while scrolling
      contentPanel.addEventListener("scroll", () => {
        if (sectionEls.length === 0) return;

        const containerRect = contentPanel.getBoundingClientRect();
        const threshold = 40;

        let bestTag = tags[0];
        let bestDelta = Infinity;

        sectionEls.forEach((sec) => {
          const rect = sec.getBoundingClientRect();
          const delta = rect.top - containerRect.top;
          if (delta <= threshold && Math.abs(delta) < bestDelta) {
            bestDelta = Math.abs(delta);
            bestTag = sec.dataset.tag;
          }
        });

        setActiveTag(bestTag);
      });
    }

    function loadYamlAndRender(path) {
      showLoading("Loading spec: " + path);
      fetch(path)
        .then((res) => {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.text();
        })
        .then((text) => {
          renderOpenApiFromText(text);
        })
        .catch((err) => {
          console.error("Failed to load spec:", err);
          introEl.innerHTML = "";
          showError("Failed to load spec: " + String(err));
        });
    }

    // Wire up version selector using version.js
    document.addEventListener("DOMContentLoaded", () => {
      if (window.ThreadJsVersion && window.ThreadJsVersion.initSelector) {
        ThreadJsVersion.initSelector({
          selectId: "versionSelectApi",
          noteId: "versionNoteApi",
          onReady(entry) {
            loadYamlAndRender(entry.yamlPath);
          },
          onChange(entry) {
            loadYamlAndRender(entry.yamlPath);
          },
        });
      } else {
        // Fallback if version.js is not available: try default YAML
        loadYamlAndRender("openapi.yaml");
      }
    });
  </script>
</body>
</html>
