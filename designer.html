<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ThreadJS Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">

  <style>
    /* Designer layout builds on the shared light theme vars from stylesheet.css */

    main.designer-main {
      flex: 1;
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr) 320px;
      grid-template-rows: minmax(0, 1fr) 220px;
      gap: 0;
      border-top: 1px solid var(--border-light, #dee2e6);
      min-height: 0;
      background: var(--bg-primary, #f8f9fa);
    }

    /* Left toolbox */
    #toolbox {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
      border-right: 1px solid var(--border-light, #dee2e6);
      background: var(--bg-secondary, #ffffff);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #toolbox h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary, #495057);
    }

    .tool-group-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary, #495057);
      margin: 0.4rem 0 0.25rem;
    }

    .node-type {
      padding: 0.35rem 0.45rem;
      border-radius: 6px;
      border: 1px dashed var(--border-medium, #adb5bd);
      background: #ffffff;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    .node-type:hover {
      background: #f1f3f5;
      border-color: var(--accent, #6c757d);
      transform: translateY(-1px);
    }

    /* Center canvas */
    #canvas-wrapper {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: #e9ecef;
      position: relative;
      overflow: auto;
    }

    #canvas {
      position: relative;
      width: 2000px;
      height: 1200px;
      background-image:
        linear-gradient(#dee2e6 1px, transparent 1px),
        linear-gradient(90deg, #dee2e6 1px, transparent 1px);
      background-size: 20px 20px;
      background-color: #f1f3f5;
    }

    .node {
      position: absolute;
      min-width: 160px;
      max-width: 260px;
      padding: 0.45rem 0.55rem;
      border-radius: 8px;
      border: 1px solid var(--border-medium, #adb5bd);
      background: #ffffff;
      box-shadow: var(--shadow-sm, 0 1px 3px rgba(0,0,0,0.08));
      cursor: move;
      font-size: 0.82rem;
      box-sizing: border-box;
    }

    .node.selected {
      border-color: #ffd43b;
      box-shadow: 0 0 0 2px rgba(255, 212, 59, 0.5);
    }

    .node-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .node-io {
      font-size: 0.75rem;
      color: var(--text-secondary, #495057);
    }

    /* Right properties / controls */
    #sidebar-right {
      grid-column: 3 / 4;
      grid-row: 1 / 2;
      border-left: 1px solid var(--border-light, #dee2e6);
      background: var(--bg-secondary, #ffffff);
      padding: 0.75rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #sidebar-right h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary, #495057);
    }

    .field-group {
      margin-bottom: 0.6rem;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--text-secondary, #495057);
      margin-bottom: 0.2rem;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid var(--border-light, #dee2e6);
      padding: 0.25rem 0.4rem;
      font-family: inherit;
      background: var(--bg-secondary, #ffffff);
      box-sizing: border-box;
    }

    .field-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-secondary, #495057);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    #sidebar-right button {
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      border: 1px solid var(--border-medium, #adb5bd);
      background: #e9ecef;
      color: var(--text-primary, #1a1d20);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    #sidebar-right button:hover {
      background: var(--accent, #6c757d);
      color: #ffffff;
      border-color: var(--accent-hover, #495057);
      transform: translateY(-1px);
    }

    /* Bottom: JS preview */
    #preview-panel {
      grid-column: 2 / 4;
      grid-row: 2 / 3;
      border-top: 1px solid var(--border-light, #dee2e6);
      background: #f1f3f5;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #preview-header {
      padding: 0.4rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.82rem;
      color: var(--text-secondary, #495057);
      background: #e9ecef;
    }

    #preview-header button {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-medium, #adb5bd);
      background: #f8f9fa;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    #preview-header button:hover {
      background: var(--accent, #6c757d);
      color: #ffffff;
      border-color: var(--accent-hover, #495057);
      transform: translateY(-1px);
    }

    #preview-code {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: var(--code-bg, #212529);
      color: var(--code-text, #f8f9fa);
      font-family: "Fira Code", "Courier New", monospace;
      font-size: 0.8rem;
      border-top: 1px solid var(--code-border, #343a40);
      overflow: auto;
      white-space: pre;
      margin: 0;
    }

    #upload-input {
      display: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      main.designer-main {
        grid-template-columns: 200px minmax(0, 1fr);
        grid-template-rows: minmax(0, 1fr) 220px 260px;
      }
      #sidebar-right {
        grid-column: 1 / 3;
        grid-row: 2 / 3;
        border-left: none;
        border-top: 1px solid var(--border-light, #dee2e6);
        flex-direction: row;
        flex-wrap: wrap;
      }
      #sidebar-right > div {
        min-width: 220px;
        flex: 1 1 240px;
      }
      #preview-panel {
        grid-column: 1 / 3;
        grid-row: 3 / 4;
      }
    }

    @media (max-width: 768px) {
      main.designer-main {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto 260px 260px;
      }
      #toolbox {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
        border-right: none;
        border-bottom: 1px solid var(--border-light, #dee2e6);
      }
      #canvas-wrapper {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      #sidebar-right {
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
      #preview-panel {
        grid-column: 1 / 2;
        grid-row: 4 / 5;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- Left: ThreadJS brand + Lynk link -->
      <div style="display:flex; align-items:center; gap:0.75rem;">
        <a href="../" class="brand">
          <div class="brand-mark">T</div>
          <div class="brand-labels">
            <div class="brand-text-main">ThreadJS</div>
            <div class="brand-text-sub">Minecraft JS scripting</div>
          </div>
        </a>

        <!-- Back to main homepage -->
        <a class="nav-pill" href="https://2lynk.github.io/">Lynk</a>
      </div>

      <!-- Right: ThreadJS section navigation -->
      <nav class="nav-links">
        <a class="nav-pill" href="index.html">API Reference</a>
        <a class="nav-pill" href="inspector.html">Inspector</a>
        <a class="nav-pill" href="example-mods.html">Example Mods</a>
        <a class="nav-pill nav-pill--accent" href="designer.html">Designer</a>
      </nav>
    </div>
  </header>

  <main class="designer-main">
    <!-- Toolbox -->
    <aside id="toolbox">
      <h2>Nodes</h2>

      <div>
        <div class="tool-group-title">Events</div>
        <div class="node-type" data-node-type="onJoin">On player join</div>
        <div class="node-type" data-node-type="onChat">On player chat</div>
        <div class="node-type" data-node-type="onTick">On server tick</div>
      </div>

      <div>
        <div class="tool-group-title">Actions</div>
        <div class="node-type" data-node-type="log">Log message</div>
        <div class="node-type" data-node-type="broadcast">Broadcast to all players</div>
        <div class="node-type" data-node-type="command">Run command</div>
      </div>

      <div>
        <div class="tool-group-title">Control</div>
        <div class="node-type" data-node-type="if">If condition</div>
        <div class="node-type" data-node-type="delay">Delay</div>
      </div>

      <p class="hint">
        Click a node type to add it to the canvas. Drag nodes around, select one, then edit its
        properties on the right. The JS preview updates automatically.
      </p>
    </aside>

    <!-- Canvas -->
    <section id="canvas-wrapper">
      <div id="canvas"></div>
    </section>

    <!-- Right sidebar: properties & graph actions -->
    <aside id="sidebar-right">
      <div style="flex:1 1 260px; min-width: 220px;">
        <h2>Node Properties</h2>

        <div class="field-group">
          <div class="field-label">Selected node</div>
          <input id="field-node-label" class="field-input" type="text" placeholder="No node selected" disabled />
        </div>

        <div class="field-group">
          <div class="field-label">Node type</div>
          <input id="field-node-type" class="field-input" type="text" disabled />
        </div>

        <div class="field-group">
          <div class="field-label">Event / Command name (if applicable)</div>
          <input id="field-node-event" class="field-input" type="text" placeholder="e.g. playerJoin, say, myCommand" />
        </div>

        <div class="field-group">
          <div class="field-label">Message / details</div>
          <textarea id="field-node-message" class="field-textarea" placeholder="Optional message or details for this node"></textarea>
        </div>

        <div class="field-group">
          <div class="field-label">Custom JS snippet (advanced)</div>
          <textarea id="field-node-custom" class="field-textarea" placeholder="// extra code that will be inserted for this node"></textarea>
        </div>

        <p class="hint">
          <strong>Note:</strong> The Designer generates a mod stub from your graph. You can always
          edit the exported JS file by hand afterwards.
        </p>
      </div>

      <div style="flex:0 0 220px; min-width: 220px;">
        <h2>Graph</h2>
        <div class="field-group">
          <div class="field-label">Graph actions</div>
          <div class="button-row">
            <button id="btn-new-graph" type="button">New graph</button>
            <button id="btn-export-json" type="button">Export graph (.json)</button>
            <button id="btn-import-json" type="button">Import graph (.json)</button>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Status</div>
          <div id="designer-status" class="hint">Ready.</div>
        </div>

        <input id="upload-input" type="file" accept=".json" />
      </div>
    </aside>

    <!-- JS preview -->
    <section id="preview-panel">
      <div id="preview-header">
        <span>Generated ThreadJS mod (read-only preview)</span>
        <button id="btn-download-js" type="button">Download mod (.js)</button>
      </div>
      <pre id="preview-code"></pre>
    </section>
  </main>

  <script>
    // Simple in-page designer logic

    const canvasWrapper = document.getElementById("canvas-wrapper");
    const canvasEl      = document.getElementById("canvas");
    const toolbox       = document.getElementById("toolbox");

    const fieldLabel    = document.getElementById("field-node-label");
    const fieldType     = document.getElementById("field-node-type");
    const fieldEvent    = document.getElementById("field-node-event");
    const fieldMessage  = document.getElementById("field-node-message");
    const fieldCustom   = document.getElementById("field-node-custom");

    const statusEl      = document.getElementById("designer-status");
    const previewCodeEl = document.getElementById("preview-code");
    const uploadInput   = document.getElementById("upload-input");

    const btnNewGraph   = document.getElementById("btn-new-graph");
    const btnExportJson = document.getElementById("btn-export-json");
    const btnImportJson = document.getElementById("btn-import-json");
    const btnDownloadJs = document.getElementById("btn-download-js");

    const nodeTypeButtons = toolbox.querySelectorAll(".node-type");

    let nodes = [];        // { id, type, label, x, y, eventName, message, customCode }
    let nextNodeId = 1;
    let selectedNodeId = null;

    function setStatus(text, isError) {
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.style.color = isError ? "#b91c1c" : "var(--text-secondary, #495057)";
    }

    function findNode(id) {
      return nodes.find(n => n.id === id) || null;
    }

    function createNode(type, x, y) {
      const label = defaultLabelForType(type);
      const node = {
        id: nextNodeId++,
        type,
        label,
        x,
        y,
        eventName: "",
        message: "",
        customCode: ""
      };
      nodes.push(node);
      renderNode(node);
      selectNode(node.id);
      updatePreview();
    }

    function defaultLabelForType(type) {
      switch (type) {
        case "onJoin": return "On player join";
        case "onChat": return "On player chat";
        case "onTick": return "On server tick";
        case "log": return "Log message";
        case "broadcast": return "Broadcast";
        case "command": return "Run command";
        case "if": return "If condition";
        case "delay": return "Delay";
        default: return type;
      }
    }

    function renderNode(node) {
      let el = canvasEl.querySelector('[data-node-id="' + node.id + '"]');
      if (!el) {
        el = document.createElement("div");
        el.className = "node";
        el.dataset.nodeId = String(node.id);

        const title = document.createElement("div");
        title.className = "node-title";
        el.appendChild(title);

        const io = document.createElement("div");
        io.className = "node-io";
        el.appendChild(io);

        canvasEl.appendChild(el);

        // click -> select node
        el.addEventListener("mousedown", (e) => {
          if (e.button === 0) {
            e.stopPropagation();
            selectNode(node.id);
          }
        });

        // basic drag
        makeNodeDraggable(el, node);
      }

      el.style.left = node.x + "px";
      el.style.top  = node.y + "px";

      const titleEl = el.querySelector(".node-title");
      const ioEl    = el.querySelector(".node-io");
      if (titleEl) titleEl.textContent = node.label || "(" + node.type + ")";
      if (ioEl)    ioEl.textContent =
        node.type +
        (node.eventName ? " :: " + node.eventName : "") +
        (node.message ? " — " + node.message.slice(0, 24) : "");
      el.classList.toggle("selected", node.id === selectedNodeId);
    }

    function rerenderAllNodes() {
      nodes.forEach(renderNode);
    }

    function clearSelection() {
      selectedNodeId = null;
      canvasEl.querySelectorAll(".node").forEach(el => {
        el.classList.remove("selected");
      });
      refreshSidebarFields();
    }

    function selectNode(id) {
      selectedNodeId = id;
      canvasEl.querySelectorAll(".node").forEach(el => {
        el.classList.toggle("selected", Number(el.dataset.nodeId) === id);
      });
      refreshSidebarFields();
    }

    function refreshSidebarFields() {
      const node = selectedNodeId ? findNode(selectedNodeId) : null;
      if (!node) {
        fieldLabel.value   = "";
        fieldType.value    = "";
        fieldEvent.value   = "";
        fieldMessage.value = "";
        fieldCustom.value  = "";
        fieldLabel.placeholder = "No node selected";
        fieldLabel.disabled = true;
        fieldEvent.disabled = true;
        fieldMessage.disabled = true;
        fieldCustom.disabled = true;
        return;
      }

      fieldLabel.disabled   = false;
      fieldEvent.disabled   = false;
      fieldMessage.disabled = false;
      fieldCustom.disabled  = false;

      fieldLabel.placeholder = "";
      fieldLabel.value   = node.label || "";
      fieldType.value    = node.type || "";
      fieldEvent.value   = node.eventName || "";
      fieldMessage.value = node.message || "";
      fieldCustom.value  = node.customCode || "";
    }

    function attachFieldHandlers() {
      fieldLabel.addEventListener("input", () => {
        const node = selectedNodeId ? findNode(selectedNodeId) : null;
        if (!node) return;
        node.label = fieldLabel.value;
        renderNode(node);
        updatePreview();
      });

      fieldEvent.addEventListener("input", () => {
        const node = selectedNodeId ? findNode(selectedNodeId) : null;
        if (!node) return;
        node.eventName = fieldEvent.value;
        renderNode(node);
        updatePreview();
      });

      fieldMessage.addEventListener("input", () => {
        const node = selectedNodeId ? findNode(selectedNodeId) : null;
        if (!node) return;
        node.message = fieldMessage.value;
        renderNode(node);
        updatePreview();
      });

      fieldCustom.addEventListener("input", () => {
        const node = selectedNodeId ? findNode(selectedNodeId) : null;
        if (!node) return;
        node.customCode = fieldCustom.value;
        updatePreview();
      });
    }

    // Basic mouse drag for nodes
    function makeNodeDraggable(el, node) {
      let dragging = false;
      let startX = 0;
      let startY = 0;
      let nodeStartX = 0;
      let nodeStartY = 0;

      el.addEventListener("mousedown", (e) => {
        if (e.button !== 0) return;
        dragging = true;
        startX = e.clientX;
        startY = e.clientY;
        nodeStartX = node.x;
        nodeStartY = node.y;
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      function onMove(e) {
        if (!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        node.x = nodeStartX + dx;
        node.y = nodeStartY + dy;
        renderNode(node);
      }

      function onUp() {
        dragging = false;
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        updatePreview();
      }
    }

    // Click on empty canvas -> clear selection
    canvasEl.addEventListener("mousedown", (e) => {
      if (e.target === canvasEl) {
        clearSelection();
      }
    });

    // Add node from toolbox
    nodeTypeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.nodeType;
        const rect = canvasWrapper.getBoundingClientRect();
        const scrollLeft = canvasWrapper.scrollLeft;
        const scrollTop  = canvasWrapper.scrollTop;
        const centerX = scrollLeft + rect.width / 2;
        const centerY = scrollTop + rect.height / 2;

        createNode(type, centerX - 80, centerY - 40);
        setStatus("Added node: " + type);
      });
    });

    // Graph actions
    btnNewGraph.addEventListener("click", () => {
      if (!confirm("Clear the current graph? This cannot be undone.")) return;
      nodes = [];
      nextNodeId = 1;
      selectedNodeId = null;
      canvasEl.innerHTML = "";
      refreshSidebarFields();
      updatePreview();
      setStatus("Graph cleared.");
    });

    btnExportJson.addEventListener("click", () => {
      const data = {
        version: 1,
        nodes
      };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "threadjs-designer-graph.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("Exported graph JSON.");
    });

    btnImportJson.addEventListener("click", () => {
      uploadInput.value = "";
      uploadInput.click();
    });

    uploadInput.addEventListener("change", async () => {
      const file = uploadInput.files && uploadInput.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || !Array.isArray(parsed.nodes)) {
          throw new Error("JSON has no 'nodes' array");
        }
        nodes = parsed.nodes.map(n => ({
          id: Number(n.id) || (nextNodeId++),
          type: n.type || "node",
          label: n.label || defaultLabelForType(n.type || "node"),
          x: Number(n.x) || 40,
          y: Number(n.y) || 40,
          eventName: n.eventName || "",
          message: n.message || "",
          customCode: n.customCode || ""
        }));
        // ensure next id is larger than any we loaded
        const maxId = nodes.reduce((m, n) => Math.max(m, n.id), 0);
        nextNodeId = maxId + 1;
        selectedNodeId = null;

        canvasEl.innerHTML = "";
        nodes.forEach(renderNode);
        refreshSidebarFields();
        updatePreview();
        setStatus("Imported graph with " + nodes.length + " node(s).");
      } catch (err) {
        console.error(err);
        setStatus("Failed to import graph: " + err.message, true);
      }
    });

    btnDownloadJs.addEventListener("click", () => {
      const code = previewCodeEl.textContent || "";
      const blob = new Blob([code], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "threadjs-designer-mod.js";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("Downloaded generated mod file.");
    });

    // Generate JS from nodes
    function generateJs() {
      const lines = [];
      lines.push("// Auto-generated by ThreadJS Designer");
      lines.push("// You can modify this file after export.");
      lines.push("");
      lines.push("module.exports = function(api) {");

      // For a simple first version, we just emit each node as a block.
      // You can refine this later (e.g. real flow connections, etc.).
      nodes.forEach(node => {
        const label = node.label || "(" + node.type + ")";
        const ev = node.eventName || "";
        const msg = node.message || "";

        lines.push("");
        lines.push("  // Node #" + node.id + " — " + label);

        switch (node.type) {
          case "onJoin":
            lines.push(
              '  api.on("playerJoin", (player, ctx) => {',
              msg ? '    api.log("[' + escapeString(label) + '] " + ' + JSON.stringify(msg) + ');' : "    // TODO: add logic for player join",
              node.customCode ? indentLines(node.customCode, 4) : "",
              "  });"
            );
            break;
          case "onChat":
            lines.push(
              '  api.on("playerChat", (player, message, ctx) => {',
              msg ? '    api.log("[' + escapeString(label) + '] " + ' + JSON.stringify(msg) + ');' : "    // TODO: add logic for chat",
              node.customCode ? indentLines(node.customCode, 4) : "",
              "  });"
            );
            break;
          case "onTick":
            lines.push(
              '  api.on("tick", (ctx) => {',
              msg ? '    api.log("[' + escapeString(label) + '] " + ' + JSON.stringify(msg) + ');' : "    // TODO: add logic for tick",
              node.customCode ? indentLines(node.customCode, 4) : "",
              "  });"
            );
            break;
          case "log":
            lines.push(
              "  api.log(" +
              (msg ? JSON.stringify(msg) : JSON.stringify(label)) +
              ");"
            );
            if (node.customCode) {
              lines.push(indentLines(node.customCode, 2));
            }
            break;
          case "broadcast":
            lines.push(
              "  api.broadcast(" +
              (msg ? JSON.stringify(msg) : JSON.stringify(label)) +
              ");"
            );
            if (node.customCode) {
              lines.push(indentLines(node.customCode, 2));
            }
            break;
          case "command":
            {
              const cmd = ev || "myCommand";
              lines.push(
                '  api.registerCommand("' + escapeString(cmd) + '", (player, args, ctx) => {',
                msg ? '    api.log("[' + escapeString(label) + '] " + ' + JSON.stringify(msg) + ');' : "    // TODO: add command logic",
                node.customCode ? indentLines(node.customCode, 4) : "",
                "  });"
              );
            }
            break;
          case "if":
            lines.push(
              "  if (/* TODO: condition for '" + label + "' */ true) {",
              msg ? "    // " + msg : "    // condition passed",
              node.customCode ? indentLines(node.customCode, 4) : "",
              "  }"
            );
            break;
          case "delay":
            lines.push(
              "  api.delay(1000, () => {",
              msg ? '    api.log(' + JSON.stringify(msg) + ');' : "    // TODO: delayed logic",
              node.customCode ? indentLines(node.customCode, 4) : "",
              "  });"
            );
            break;
          default:
            lines.push("  // TODO: node type '" + node.type + "'");
            if (node.customCode) {
              lines.push(indentLines(node.customCode, 2));
            }
            break;
        }
      });

      lines.push("");
      lines.push("};");
      lines.push("");

      return lines.join("\n");
    }

    function updatePreview() {
      if (!previewCodeEl) return;
      previewCodeEl.textContent = generateJs();
    }

    function escapeString(str) {
      return String(str).replace(/"/g, '\\"');
    }

    function indentLines(str, spaces) {
      const pad = " ".repeat(spaces);
      return String(str)
        .split("\n")
        .map((line) => (line.trim() ? pad + line : ""))
        .join("\n");
    }

    // Initial boot
    attachFieldHandlers();
    updatePreview();
    setStatus("Ready.");
  </script>
</body>
</html>
