<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ThreadJS – Designer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">

  <style>
    /* Page-specific layout + node/editor styling.
       Colors & base typography come from stylesheet.css via CSS variables. */

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr) 320px;
      grid-template-rows: minmax(0, 1fr) 220px;
      border-top: 1px solid var(--border-light);
      min-height: 0;
    }

    /* Left toolbox */
    #toolbox {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
      border-right: 1px solid var(--border-light);
      background: var(--bg-secondary);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #toolbox h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .tool-group-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin: 0.4rem 0 0.25rem;
    }

    .node-type {
      padding: 0.35rem 0.45rem;
      border-radius: 6px;
      border: 1px dashed var(--border-medium);
      background: var(--bg-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .node-type span.label {
      flex: 1;
    }

    .node-type span.small {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .node-type:hover {
      background: #ffffff;
      border-style: solid;
    }

    /* Center canvas */
    #canvas-wrapper {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: #e9ecef;
      position: relative;
      overflow: auto;
    }

    #canvas {
      position: relative;
      width: 2000px;
      height: 1200px;
      background-image:
        linear-gradient(#dee2e6 1px, transparent 1px),
        linear-gradient(90deg, #dee2e6 1px, transparent 1px);
      background-size: 20px 20px;
      background-color: #f1f3f5;
    }

    .node {
      position: absolute;
      min-width: 170px;
      max-width: 260px;
      padding: 0.45rem 0.55rem;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      box-shadow: var(--shadow-sm);
      cursor: move;
      font-size: 0.82rem;
    }

    .node.selected {
      border-color: #ffd43b;
      box-shadow: 0 0 0 2px rgba(255, 212, 59, 0.5);
    }

    .node-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .node-io {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .node-footer {
      margin-top: 0.3rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Right properties / controls */
    #sidebar-right {
      grid-column: 3 / 4;
      grid-row: 1 / 2;
      border-left: 1px solid var(--border-light);
      background: var(--bg-secondary);
      padding: 0.75rem 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #sidebar-right h2 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    .field-group {
      margin-bottom: 0.5rem;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.2rem;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      font-size: 0.85rem;
      border-radius: 6px;
      border: 1px solid var(--border-light);
      padding: 0.25rem 0.4rem;
      font-family: inherit;
      background: var(--bg-secondary);
    }

    .field-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .btn-soft {
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      border: 1px solid var(--border-medium);
      background: #e9ecef;
      color: var(--text-primary);
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-soft:hover {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent-hover);
    }

    /* Bottom: JS preview */
    #preview-panel {
      grid-column: 2 / 4;
      grid-row: 2 / 3;
      border-top: 1px solid var(--border-light);
      background: #f1f3f5;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #preview-header {
      padding: 0.4rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.82rem;
      color: var(--text-secondary);
      background: #e9ecef;
    }

    #preview-code {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: var(--code-bg);
      color: var(--code-text);
      font-family: "Fira Code", monospace;
      font-size: 0.8rem;
      border-top: 1px solid var(--code-border);
      overflow: auto;
      white-space: pre;
    }

    #upload-input {
      display: none;
    }

    .badge-small {
      font-size: 0.75rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: #f8f9fa;
      color: var(--text-secondary);
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 200px minmax(0, 1fr);
        grid-template-rows: minmax(0, 1fr) 240px 260px;
      }
      #sidebar-right {
        grid-column: 1 / 3;
        grid-row: 2 / 3;
        border-left: none;
        border-top: 1px solid var(--border-light);
        flex-direction: row;
        flex-wrap: wrap;
      }
      #preview-panel {
        grid-column: 1 / 3;
        grid-row: 3 / 4;
      }
    }
  </style>
</head>

<body>
  <!-- Shared header / nav, same style as other ThreadJS pages -->
  <header>
    <div class="header-inner">
      <a href="index.html" class="brand">
        <div class="brand-mark">T</div>
        <div class="brand-labels">
          <div class="brand-text-main">ThreadJS</div>
          <div class="brand-text-sub">Minecraft JS scripting</div>
        </div>
      </a>
      <nav class="nav-links">
        <a class="nav-pill" href="index.html">Reference</a>
        <a class="nav-pill" href="inspector.html">Inspector</a>
        <a class="nav-pill" href="example-mods.html">Example mods</a>
        <a class="nav-pill nav-pill--accent" href="designer.html">Designer</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- LEFT: Toolbox -->
    <aside id="toolbox">
      <h2>Nodes</h2>

      <div class="tool-group-title">Core</div>
      <div class="node-type" data-node-type="log">
        <span class="label">Log message</span>
        <span class="small">api.log()</span>
      </div>
      <div class="node-type" data-node-type="sendMessage">
        <span class="label">Broadcast chat</span>
        <span class="small">api.sendMessage()</span>
      </div>

      <div class="tool-group-title">Events</div>
      <div class="node-type" data-node-type="onJoin">
        <span class="label">On player join</span>
        <span class="small">api.onPlayerJoin()</span>
      </div>
      <div class="node-type" data-node-type="onChat">
        <span class="label">On chat message</span>
        <span class="small">api.onChatMessage()</span>
      </div>

      <div class="tool-group-title">Commands</div>
      <div class="node-type" data-node-type="command">
        <span class="label">Custom command</span>
        <span class="small">api.registerCommand()</span>
      </div>

      <div class="tool-group-title">World / Players</div>
      <div class="node-type" data-node-type="giveItem">
        <span class="label">Give item</span>
        <span class="small">api.players.giveItem()</span>
      </div>
      <div class="node-type" data-node-type="teleport">
        <span class="label">Teleport</span>
        <span class="small">api.players.teleport()</span>
      </div>

      <div class="tool-group-title">Mod meta</div>
      <div class="node-type" data-node-type="mod">
        <span class="label">Mod root</span>
        <span class="small">api.registerMod()</span>
      </div>
    </aside>

    <!-- CENTER: Canvas -->
    <section id="canvas-wrapper">
      <div id="canvas"></div>
    </section>

    <!-- RIGHT: Properties -->
    <aside id="sidebar-right">
      <div style="flex: 1; min-width: 0;">
        <h2>Node properties</h2>
        <div id="nodePropsEmpty" class="hint">
          Select a node on the canvas to edit its properties.
        </div>
        <div id="nodeProps" style="display:none;">
          <div class="field-group">
            <div class="field-label">Node title</div>
            <input id="propTitle" class="field-input" />
          </div>
          <div class="field-group">
            <div class="field-label">Description (optional)</div>
            <textarea id="propDescription" class="field-textarea"></textarea>
          </div>
          <div class="field-group" id="fieldExtra1" style="display:none;">
            <div class="field-label" id="fieldExtra1Label"></div>
            <input id="fieldExtra1Input" class="field-input" />
          </div>
          <div class="field-group" id="fieldExtra2" style="display:none;">
            <div class="field-label" id="fieldExtra2Label"></div>
            <input id="fieldExtra2Input" class="field-input" />
          </div>
        </div>
      </div>

      <div style="flex: 0 0 auto;">
        <h2>Graph</h2>
        <div class="hint">
          This editor exports plain <code>.js</code> mods that you can drop into
          <code>config/jsmods</code>.
        </div>
        <div class="button-row">
          <button type="button" class="btn-soft" id="btnGenerate">Refresh code</button>
          <button type="button" class="btn-soft" id="btnDownload">Download .js</button>
          <button type="button" class="btn-soft" id="btnSaveJson">Download blueprint</button>
          <button type="button" class="btn-soft" id="btnLoadJson">Load blueprint</button>
        </div>
        <input type="file" id="upload-input" accept="application/json" />
      </div>
    </aside>

    <!-- BOTTOM: Preview -->
    <section id="preview-panel">
      <div id="preview-header">
        <span>Generated ThreadJS mod</span>
        <span class="badge-small">Drop into <code>config/jsmods</code> and reload</span>
      </div>
      <pre id="preview-code">// Your generated JavaScript mod will appear here.</pre>
    </section>
  </main>

  <script>
    // ----- Data model -----
    let nodes = [];
    let selectedNodeId = null;
    let dragState = null;

    const canvasWrapper = document.getElementById("canvas-wrapper");
    const canvas = document.getElementById("canvas");

    // Node templates: define extra fields for each type
    const NODE_TEMPLATES = {
      mod: {
        title: "My ThreadJS Mod",
        description: "Root mod: use this to initialize your logic.",
        extra1Label: "Mod ID",
        extra1Key: "modId",
        extra1Default: "my-mod",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      },
      log: {
        title: "Log message",
        description: "Write a line to the server console.",
        extra1Label: "Message",
        extra1Key: "message",
        extra1Default: "Hello from ThreadJS!",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      },
      sendMessage: {
        title: "Broadcast chat",
        description: "Send a chat message to all players.",
        extra1Label: "Chat message",
        extra1Key: "message",
        extra1Default: "Welcome to the server!",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      },
      onJoin: {
        title: "On player join",
        description: "Runs when a player joins the server.",
        extra1Label: "Welcome message",
        extra1Key: "message",
        extra1Default: "✨ ${player.name} joined the server!",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      },
      onChat: {
        title: "On chat message",
        description: "Runs on every chat message.",
        extra1Label: "Filter word (optional)",
        extra1Key: "filter",
        extra1Default: "",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      },
      command: {
        title: "Custom command",
        description: "Create a simple /command.",
        extra1Label: "Command name",
        extra1Key: "commandName",
        extra1Default: "ping",
        extra2Label: "Reply text",
        extra2Key: "reply",
        extra2Default: "Pong!"
      },
      giveItem: {
        title: "Give item",
        description: "Give an item to a player.",
        extra1Label: "Item ID",
        extra1Key: "itemId",
        extra1Default: "minecraft:diamond_sword",
        extra2Label: "Count",
        extra2Key: "count",
        extra2Default: "1"
      },
      teleport: {
        title: "Teleport",
        description: "Teleport a player.",
        extra1Label: "Target X Y Z",
        extra1Key: "coords",
        extra1Default: "0 80 0",
        extra2Label: "",
        extra2Key: "",
        extra2Default: ""
      }
    };

    function createNode(type, x, y) {
      const tpl = NODE_TEMPLATES[type] || {};
      const id = "node_" + Math.random().toString(36).slice(2, 9);
      const node = {
        id,
        type,
        x,
        y,
        title: tpl.title || type,
        description: tpl.description || "",
        extra: {
          [tpl.extra1Key || ""]: tpl.extra1Default || "",
          [tpl.extra2Key || ""]: tpl.extra2Default || ""
        }
      };
      nodes.push(node);
      renderNodes();
      selectNode(id);
    }

    // ----- Rendering -----
    function renderNodes() {
      canvas.innerHTML = "";
      nodes.forEach(node => {
        const div = document.createElement("div");
        div.className = "node" + (node.id === selectedNodeId ? " selected" : "");
        div.style.left = node.x + "px";
        div.style.top = node.y + "px";
        div.dataset.id = node.id;

        const tpl = NODE_TEMPLATES[node.type] || {};

        const title = document.createElement("div");
        title.className = "node-title";
        title.textContent = node.title || tpl.title || node.type;
        div.appendChild(title);

        const io = document.createElement("div");
        io.className = "node-io";
        io.textContent = shortNodeLabel(node.type);
        div.appendChild(io);

        if (node.description) {
          const footer = document.createElement("div");
          footer.className = "node-footer";
          footer.textContent = node.description;
          div.appendChild(footer);
        }

        // Drag start
        div.addEventListener("mousedown", (e) => {
          e.preventDefault();
          selectNode(node.id);
          dragState = {
            nodeId: node.id,
            startX: e.clientX,
            startY: e.clientY,
            nodeStartX: node.x,
            nodeStartY: node.y
          };
        });

        canvas.appendChild(div);
      });
    }

    function shortNodeLabel(type) {
      switch (type) {
        case "mod": return "api.registerMod()";
        case "log": return "api.log(message)";
        case "sendMessage": return "api.sendMessage(message)";
        case "onJoin": return "api.onPlayerJoin(player => …)";
        case "onChat": return "api.onChatMessage(evt => …)";
        case "command": return "api.registerCommand(name, handler)";
        case "giveItem": return "api.players.giveItem(player, item, count)";
        case "teleport": return "api.players.teleport(player, x,y,z,dim)";
        default: return type;
      }
    }

    // ----- Selection & properties -----
    const nodePropsEmpty = document.getElementById("nodePropsEmpty");
    const nodeProps = document.getElementById("nodeProps");
    const propTitle = document.getElementById("propTitle");
    const propDescription = document.getElementById("propDescription");
    const fieldExtra1 = document.getElementById("fieldExtra1");
    const fieldExtra2 = document.getElementById("fieldExtra2");
    const fieldExtra1Label = document.getElementById("fieldExtra1Label");
    const fieldExtra2Label = document.getElementById("fieldExtra2Label");
    const fieldExtra1Input = document.getElementById("fieldExtra1Input");
    const fieldExtra2Input = document.getElementById("fieldExtra2Input");

    function selectNode(id) {
      selectedNodeId = id;
      renderNodes();
      updatePropertyPanel();
      generateCode();
    }

    function getSelectedNode() {
      return nodes.find(n => n.id === selectedNodeId) || null;
    }

    function updatePropertyPanel() {
      const node = getSelectedNode();
      if (!node) {
        nodePropsEmpty.style.display = "";
        nodeProps.style.display = "none";
        return;
      }
      const tpl = NODE_TEMPLATES[node.type] || {};

      nodePropsEmpty.style.display = "none";
      nodeProps.style.display = "";

      propTitle.value = node.title || "";
      propDescription.value = node.description || "";

      if (tpl.extra1Key) {
        fieldExtra1.style.display = "";
        fieldExtra1Label.textContent = tpl.extra1Label || tpl.extra1Key;
        fieldExtra1Input.value = (node.extra && node.extra[tpl.extra1Key]) || "";
      } else {
        fieldExtra1.style.display = "none";
      }

      if (tpl.extra2Key) {
        fieldExtra2.style.display = "";
        fieldExtra2Label.textContent = tpl.extra2Label || tpl.extra2Key;
        fieldExtra2Input.value = (node.extra && node.extra[tpl.extra2Key]) || "";
      } else {
        fieldExtra2.style.display = "none";
      }
    }

    propTitle.addEventListener("input", () => {
      const node = getSelectedNode();
      if (!node) return;
      node.title = propTitle.value;
      renderNodes();
      generateCode();
    });

    propDescription.addEventListener("input", () => {
      const node = getSelectedNode();
      if (!node) return;
      node.description = propDescription.value;
      renderNodes();
      generateCode();
    });

    fieldExtra1Input.addEventListener("input", () => {
      const node = getSelectedNode();
      if (!node) return;
      const tpl = NODE_TEMPLATES[node.type] || {};
      if (!tpl.extra1Key) return;
      node.extra = node.extra || {};
      node.extra[tpl.extra1Key] = fieldExtra1Input.value;
      generateCode();
    });

    fieldExtra2Input.addEventListener("input", () => {
      const node = getSelectedNode();
      if (!node) return;
      const tpl = NODE_TEMPLATES[node.type] || {};
      if (!tpl.extra2Key) return;
      node.extra = node.extra || {};
      node.extra[tpl.extra2Key] = fieldExtra2Input.value;
      generateCode();
    });

    // ----- Dragging -----
    document.addEventListener("mousemove", (e) => {
      if (!dragState) return;
      const node = nodes.find(n => n.id === dragState.nodeId);
      if (!node) return;
      const dx = e.clientX - dragState.startX;
      const dy = e.clientY - dragState.startY;
      node.x = dragState.nodeStartX + dx;
      node.y = dragState.nodeStartY + dy;
      renderNodes();
    });

    document.addEventListener("mouseup", () => {
      dragState = null;
    });

    // ----- Toolbox handlers -----
    document.querySelectorAll(".node-type").forEach(el => {
      el.addEventListener("click", () => {
        const type = el.dataset.nodeType;
        const rect = canvasWrapper.getBoundingClientRect();
        const x = canvasWrapper.scrollLeft + rect.width / 2 - 80;
        const y = canvasWrapper.scrollTop + rect.height / 2 - 40;
        createNode(type, x, y);
      });
    });

    // ----- Code generation -----
    const previewCodeEl = document.getElementById("preview-code");

    function generateCode() {
      if (nodes.length === 0) {
        previewCodeEl.textContent = `// ThreadJS blueprint
// Add nodes in the Designer to generate a mod.`;
        return;
      }

      const modNode = nodes.find(n => n.type === "mod");
      const modId = (modNode && modNode.extra && modNode.extra.modId) || "my-mod";

      let lines = [];
      lines.push(`// Generated by ThreadJS Designer`);
      lines.push(`// Drop this file into config/jsmods and run /threadjs reload`);
      lines.push("");
      lines.push(`api.registerMod("${modId}", {`);
      lines.push(`  onInitialize(api) {`);

      // log & sendMessage nodes
      nodes.filter(n => n.type === "log").forEach(n => {
        const msg = (n.extra && n.extra.message) || "Hello from ThreadJS!";
        lines.push(`    api.log(${JSON.stringify(msg)});`);
      });

      nodes.filter(n => n.type === "sendMessage").forEach(n => {
        const msg = (n.extra && n.extra.message) || "Welcome to the server!";
        lines.push(`    api.sendMessage(${JSON.stringify(msg)});`);
      });

      // onJoin
      if (nodes.some(n => n.type === "onJoin")) {
        lines.push("");
        lines.push(`    api.onPlayerJoin(player => {`);
        nodes.filter(n => n.type === "onJoin").forEach(n => {
          const msg = (n.extra && n.extra.message) || "✨ ${player.name} joined the server!";
          lines.push(`      api.sendMessage(\`${msg}\`);`);
        });
        lines.push(`    });`);
      }

      // onChat
      if (nodes.some(n => n.type === "onChat")) {
        lines.push("");
        lines.push(`    api.onChatMessage(evt => {`);
        nodes.filter(n => n.type === "onChat").forEach(n => {
          const filter = (n.extra && n.extra.filter) || "";
          if (filter.trim()) {
            lines.push(`      if (evt.message.includes(${JSON.stringify(filter)})) {`);
            lines.push(`        api.log("Filtered word in chat: " + evt.message);`);
            lines.push(`      }`);
          } else {
            lines.push(`      // TODO: handle chat: evt.player, evt.message`);
          }
        });
        lines.push(`    });`);
      }

      // Commands
      nodes.filter(n => n.type === "command").forEach(n => {
        const cmd = (n.extra && n.extra.commandName) || "ping";
        const reply = (n.extra && n.extra.reply) || "Pong!";
        lines.push("");
        lines.push(`    api.registerCommand("${cmd}", (ctx, args) => {`);
        lines.push(`      ctx.reply(${JSON.stringify(reply)});`);
        lines.push(`    });`);
      });

      // World / players
      nodes.filter(n => n.type === "giveItem").forEach(n => {
        const itemId = (n.extra && n.extra.itemId) || "minecraft:diamond_sword";
        const count = Number((n.extra && n.extra.count) || "1") || 1;
        lines.push("");
        lines.push(`    // Example: give item to the first online player`);
        lines.push(`    const p = api.players.list()[0];`);
        lines.push(`    if (p) api.players.giveItem(p.name, "${itemId}", ${count});`);
      });

      nodes.filter(n => n.type === "teleport").forEach(n => {
        const coords = (n.extra && n.extra.coords) || "0 80 0";
        lines.push("");
        lines.push(`    // Example: teleport the first online player`);
        lines.push(`    {`);
        lines.push(`      const p = api.players.list()[0];`);
        lines.push(`      if (p) {`);
        lines.push(`        const [x, y, z] = "${coords}".split(" ").map(Number);`);
        lines.push(`        api.players.teleport(p.name, x || 0, y || 80, z || 0, "minecraft:overworld");`);
        lines.push(`      }`);
        lines.push(`    }`);
      });

      lines.push(`  },`);
      lines.push(`  onReload(api) {`);
      lines.push(`    api.log("[${modId}] reloaded from Designer");`);
      lines.push(`  }`);
      lines.push(`});`);

      previewCodeEl.textContent = lines.join("\n");
    }

    // Buttons
    document.getElementById("btnGenerate").addEventListener("click", generateCode);

    document.getElementById("btnDownload").addEventListener("click", () => {
      const blob = new Blob([previewCodeEl.textContent], { type: "text/javascript" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "threadjs-designer-mod.js";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    document.getElementById("btnSaveJson").addEventListener("click", () => {
      const data = { nodes };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "threadjs-blueprint.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    const uploadInput = document.getElementById("upload-input");
    document.getElementById("btnLoadJson").addEventListener("click", () => {
      uploadInput.click();
    });

    uploadInput.addEventListener("change", () => {
      const file = uploadInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          nodes = Array.isArray(data.nodes) ? data.nodes : [];
          selectedNodeId = null;
          renderNodes();
          updatePropertyPanel();
          generateCode();
        } catch {
          alert("Invalid blueprint JSON");
        }
      };
      reader.readAsText(file);
    });

    // Initial state: one mod node in the middle
    window.addEventListener("load", () => {
      const rect = canvasWrapper.getBoundingClientRect();
      createNode("mod", canvasWrapper.scrollLeft + rect.width / 2 - 100, canvasWrapper.scrollTop + 80);
      generateCode();
    });
  </script>
</body>
</html>
