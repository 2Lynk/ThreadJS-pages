<!doctype html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8">
    <title>ThreadJS WebSocket Debugger</title>
    <style>
        :root {
            --bg: #181818;
            --bg-secondary: #202020;
            --bg-panel: #111111;
            --border: #333333;
            --border-soft: #222222;
            --text: #eeeeee;
            --text-muted: #aaaaaa;
            --text-muted-2: #888888;
            --input-bg: #111111;
            --input-border: #444444;
            --button-bg: #333333;
            --button-border: #555555;
            --button-bg-hover: #444444;
            --log-time: #666666;

            --tag-default: #333333;
            --tag-log: #2b5d3a;
            --tag-hello: #37548a;
            --tag-eval: #685042;
            --tag-json: #8b6c2b;

            --json-key: #9cdcfe;
            --json-string: #ce9178;
            --json-number: #b5cea8;
            --json-bool: #569cd6;
            --json-null: #808080;
            --json-brace: #888888;
            --json-sep: #888888;

            --toast-bg: #333333;
            --toast-border: #555555;

            --status-connected: #44ff44;
            --status-error: #ff5555;
            --status-connecting: #ffaa00;
        }

        html[data-theme="light"] {
            --bg: #f5f5f5;
            --bg-secondary: #e5e5e5;
            --bg-panel: #ffffff;
            --border: #cccccc;
            --border-soft: #dddddd;
            --text: #222222;
            --text-muted: #666666;
            --text-muted-2: #777777;
            --input-bg: #ffffff;
            --input-border: #bbbbbb;
            --button-bg: #e0e0e0;
            --button-border: #bbbbbb;
            --button-bg-hover: #d0d0d0;
            --log-time: #888888;

            --tag-default: #cccccc;
            --tag-log: #9ad5a8;
            --tag-hello: #9aaedb;
            --tag-eval: #d3b19c;
            --tag-json: #e0c27a;

            --json-key: #005795;
            --json-string: #b55335;
            --json-number: #4e7a26;
            --json-bool: #2962b2;
            --json-null: #888888;
            --json-brace: #555555;
            --json-sep: #555555;

            --toast-bg: #f0f0f0;
            --toast-border: #bbbbbb;

            --status-connected: #1a7f1a;
            --status-error: #c62828;
            --status-connecting: #c47f00;
        }

        * { box-sizing: border-box; }
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background: var(--bg);
            color: var(--text);
        }
        #left, #right {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #left {
            flex: 1.3;
            border-right: 1px solid var(--border);
        }
        #right {
            flex: 1;
        }
        #controls, #evalControls {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #controls-left {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        #controls-right {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        label {
            font-size: 12px;
            color: var(--text-muted);
        }
        input[type="text"] {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid var(--input-border);
            padding: 2px 4px;
            border-radius: 2px;
        }
        button {
            margin-left: 4px;
            padding: 4px 8px;
            border-radius: 2px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background: var(--button-bg-hover);
        }
        #log, #result {
            flex: 1;
            overflow: auto;
            padding: 8px;
            font-family: monospace;
            background: var(--bg-panel);
        }
        #log {
            font-size: 12px;
        }
        #result {
            border-top: 1px solid var(--border);
            white-space: pre-wrap;
        }
        textarea {
            width: 100%;
            height: 160px;
            font-family: monospace;
            font-size: 12px;
            background: var(--bg-panel);
            color: var(--text);
            border: none;
            border-top: 1px solid var(--border);
            padding: 8px;
            resize: vertical;
        }

        .log-entry {
            border-bottom: 1px solid var(--border-soft);
            padding: 4px 0;
        }
        .log-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .log-time {
            color: var(--log-time);
            font-size: 11px;
            min-width: 60px;
        }
        .log-tag {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            background: var(--tag-default);
            color: var(--text);
            text-transform: uppercase;
        }
        .log-tag.log { background: var(--tag-log); }
        .log-tag.hello { background: var(--tag-hello); }
        .log-tag.eval { background: var(--tag-eval); }
        .log-tag.json { background: var(--tag-json); }

        .log-summary {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .log-toggle {
            font-size: 10px;
            color: var(--text-muted-2);
        }
        .log-body {
            margin-top: 2px;
            padding-left: 12px;
            display: none;
        }
        .log-body.open {
            display: block;
        }

        .json-tree {
            font-size: 12px;
            line-height: 1.3;
        }
        .json-node {
            margin-left: 12px;
            position: relative;
        }
        .json-node-root {
            margin-left: 0;
        }
        .json-key {
            color: var(--json-key);
            cursor: pointer;
        }
        .json-key:hover {
            text-decoration: underline;
        }
        .json-string { color: var(--json-string); }
        .json-number { color: var(--json-number); }
        .json-bool   { color: var(--json-bool); }
        .json-null   { color: var(--json-null); }

        .json-brace, .json-bracket {
            color: var(--json-brace);
        }
        .json-sep {
            color: var(--json-sep);
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #statusText {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        #pathToast {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--toast-bg);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            border: 1px solid var(--toast-border);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-out;
            z-index: 9999;
        }
        #pathToast.show {
            opacity: 1;
        }

        #themeToggle {
            font-size: 11px;
            padding: 3px 6px;
        }
        #themeLabel {
            font-size: 11px;
            color: var(--text-muted);
        }

        #logFilter {
            font-size: 11px;
            min-width: 120px;
        }
        #clearLogBtn {
            font-size: 11px;
        }
        #autoScrollLabel {
            font-size: 11px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<div id="left">
    <div id="controls">
        <div id="controls-left">
            <label>WS URL:
                <input id="wsUrl" type="text" value="ws://127.0.0.1:31337/" size="32">
            </label>
            <button id="connectBtn">Connect</button>
            <label style="margin-left:8px;">Filter:
                <input id="logFilter" type="text" placeholder="text / type:json / tag:log">
            </label>
            <button id="clearLogBtn">Clear</button>
            <label id="autoScrollLabel">
                <input type="checkbox" id="autoScrollChk" checked> Auto-scroll
            </label>
            <span id="statusText">Disconnected</span>
        </div>
        <div id="controls-right">
            <span id="themeLabel">Theme:</span>
            <button id="themeToggle">Dark</button>
        </div>
    </div>
    <div id="log"></div>
</div>
<div id="right">
    <div id="evalControls">
        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
            <span style="font-size:12px;color:var(--text-muted);">Eval in JS runtime</span>
            <span style="font-size:11px;color:var(--text-muted-2);">Shortcut: Ctrl+Enter</span>
        </div>
    </div>
    <textarea id="code">// Type JS here and click "Eval" or press Ctrl+Enter
api.log("hello from debugger");
api.describe(api);</textarea>
    <button id="evalBtn">Eval</button>
    <div id="result"></div>
</div>

<div id="pathToast"></div>

<script>
    let ws = null;

    const logEl       = document.getElementById('log');
    const resultEl    = document.getElementById('result');
    const codeEl      = document.getElementById('code');
    const urlEl       = document.getElementById('wsUrl');
    const connectBtn  = document.getElementById('connectBtn');
    const evalBtn     = document.getElementById('evalBtn');
    const statusTxt   = document.getElementById('statusText');
    const pathToast   = document.getElementById('pathToast');
    const themeToggle = document.getElementById('themeToggle');
    const logFilterEl = document.getElementById('logFilter');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const autoScrollChk = document.getElementById('autoScrollChk');

    const STORAGE_KEY_URL = "threadjs-debug-ws-url";
    const STORAGE_KEY_CODE = "threadjs-debug-code";
    const STORAGE_KEY_THEME = "threadjs-debug-theme";

    // ==== Theme handling ====

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeToggle.textContent = theme === 'dark' ? 'Dark' : 'Light';
    }

    function loadTheme() {
        const stored = localStorage.getItem(STORAGE_KEY_THEME);
        if (stored === 'light' || stored === 'dark') return stored;
        return 'dark';
    }

    function saveTheme(theme) {
        localStorage.setItem(STORAGE_KEY_THEME, theme);
    }

    (function initTheme() {
        const theme = loadTheme();
        applyTheme(theme);
    })();

    themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        saveTheme(next);
    });

    // ==== Utility ====

    function nowTime() {
        const d = new Date();
        return d.toTimeString().split(' ')[0]; // HH:MM:SS
    }

    function showToast(text) {
        pathToast.textContent = text;
        pathToast.classList.add('show');
        setTimeout(() => pathToast.classList.remove('show'), 1200);
    }

    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showToast("Copied path: " + text);
        } catch {
            showToast("Path: " + text);
        }
    }

    // ==== JSON tree rendering with path copying ====

    function renderJsonValue(value, container, path) {
        const type = typeof value;
        if (value === null) {
            const span = document.createElement('span');
            span.className = 'json-null';
            span.textContent = 'null';
            container.appendChild(span);
        } else if (Array.isArray(value)) {
            renderJsonArray(value, container, path);
        } else if (type === 'object') {
            renderJsonObject(value, container, path);
        } else if (type === 'string') {
            const span = document.createElement('span');
            span.className = 'json-string';
            span.textContent = JSON.stringify(value);
            container.appendChild(span);
        } else if (type === 'number') {
            const span = document.createElement('span');
            span.className = 'json-number';
            span.textContent = String(value);
            container.appendChild(span);
        } else if (type === 'boolean') {
            const span = document.createElement('span');
            span.className = 'json-bool';
            span.textContent = value ? 'true' : 'false';
            container.appendChild(span);
        } else {
            const span = document.createElement('span');
            span.textContent = JSON.stringify(value);
            container.appendChild(span);
        }
    }

    function renderJsonObject(obj, container, path) {
        const keys = Object.keys(obj);
        container.appendChild(spanBrace('{'));
        if (keys.length === 0) {
            container.appendChild(spanBrace('}'));
            return;
        }
        container.appendChild(document.createTextNode('\n'));
        keys.forEach((key, index) => {
            const childNode = document.createElement('div');
            childNode.className = 'json-node';

            const childPath = path ? path + '.' + key : key;

            const keySpan = document.createElement('span');
            keySpan.className = 'json-key';
            keySpan.textContent = key;
            keySpan.dataset.path = childPath;

            keySpan.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                copyToClipboard(childPath);
            });

            childNode.appendChild(keySpan);
            childNode.appendChild(spanSep(': '));

            renderJsonValue(obj[key], childNode, childPath);

            if (index < keys.length - 1) {
                childNode.appendChild(spanSep(','));
            }

            container.appendChild(childNode);
        });
        container.appendChild(document.createTextNode('\n'));
        container.appendChild(spanBrace('}'));
    }

    function renderJsonArray(arr, container, path) {
        container.appendChild(spanBracket('['));
        if (arr.length === 0) {
            container.appendChild(spanBracket(']'));
            return;
        }
        container.appendChild(document.createTextNode('\n'));
        arr.forEach((value, index) => {
            const childNode = document.createElement('div');
            childNode.className = 'json-node';

            const childPath = path + '[' + index + ']';

            const indexSpan = document.createElement('span');
            indexSpan.className = 'json-key';
            indexSpan.textContent = String(index);
            indexSpan.dataset.path = childPath;

            indexSpan.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                copyToClipboard(childPath);
            });

            childNode.appendChild(indexSpan);
            childNode.appendChild(spanSep(': '));

            renderJsonValue(value, childNode, childPath);

            if (index < arr.length - 1) {
                childNode.appendChild(spanSep(','));
            }

            container.appendChild(childNode);
        });
        container.appendChild(document.createTextNode('\n'));
        container.appendChild(spanBracket(']'));
    }

    function spanBrace(text) {
        const span = document.createElement('span');
        span.className = 'json-brace';
        span.textContent = text;
        return span;
    }

    function spanBracket(text) {
        const span = document.createElement('span');
        span.className = 'json-bracket';
        span.textContent = text;
        return span;
    }

    function spanSep(text) {
        const span = document.createElement('span');
        span.className = 'json-sep';
        span.textContent = text;
        return span;
    }

    function createJsonTree(message) {
        let parsed;
        try {
            parsed = JSON.parse(message);
        } catch {
            const pre = document.createElement('pre');
            pre.textContent = message;
            return pre;
        }

        const root = document.createElement('div');
        root.className = 'json-tree';

        const rootNode = document.createElement('div');
        rootNode.className = 'json-node json-node-root';
        renderJsonValue(parsed, rootNode, '');
        root.appendChild(rootNode);

        return root;
    }

    // ==== Log entries ====

    function appendLogEntry(kind, tag, message) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.dataset.kind = kind;
        entry.dataset.tag = tag;
        entry.dataset.message = message.toLowerCase();

        const header = document.createElement('div');
        header.className = 'log-header';

        const timeSpan = document.createElement('span');
        timeSpan.className = 'log-time';
        timeSpan.textContent = nowTime();

        const tagSpan = document.createElement('span');
        tagSpan.className = 'log-tag ' + tag;
        tagSpan.textContent = tag.toUpperCase();

        const summarySpan = document.createElement('span');
        summarySpan.className = 'log-summary';

        const toggleSpan = document.createElement('span');
        toggleSpan.className = 'log-toggle';
        toggleSpan.textContent = '▶';

        const body = document.createElement('div');
        body.className = 'log-body';

        let summaryText = '';

        if (kind === 'json') {
            try {
                const parsed = JSON.parse(message);
                const preview = JSON.stringify(parsed, null, 2);
                summaryText = preview.substring(0, 120).replace(/\s+/g, ' ');
                if (preview.length > 120) summaryText += ' ...';

                const tree = createJsonTree(message);
                body.appendChild(tree);
            } catch {
                summaryText = message.length > 160 ? message.slice(0, 160) + ' ...' : message;
                const pre = document.createElement('pre');
                pre.textContent = message;
                body.appendChild(pre);
            }
        } else {
            summaryText = message.length > 160 ? message.slice(0, 160) + ' ...' : message;
            const pre = document.createElement('pre');
            pre.textContent = message;
            body.appendChild(pre);
        }

        summarySpan.textContent = summaryText;

        header.appendChild(timeSpan);
        header.appendChild(tagSpan);
        header.appendChild(summarySpan);
        header.appendChild(toggleSpan);

        header.onclick = () => {
            const open = body.classList.toggle('open');
            toggleSpan.textContent = open ? '▼' : '▶';
        };

        entry.appendChild(header);
        entry.appendChild(body);
        logEl.appendChild(entry);

        if (autoScrollChk.checked) {
            logEl.scrollTop = logEl.scrollHeight;
        }

        applyLogFilter(); // ensure new entry respects current filter
    }

    // ==== Log filtering / clear ====

    function applyLogFilter() {
        const raw = logFilterEl.value.trim().toLowerCase();
        const entries = logEl.querySelectorAll('.log-entry');
        if (!raw) {
            entries.forEach(e => e.style.display = '');
            return;
        }

        let filterKind = null;
        let filterTag = null;
        let filterText = null;

        if (raw.startsWith('type:')) {
            filterKind = raw.substring(5);
        } else if (raw.startsWith('tag:')) {
            filterTag = raw.substring(4);
        } else {
            filterText = raw;
        }

        entries.forEach(e => {
            const kind = e.dataset.kind || '';
            const tag  = e.dataset.tag  || '';
            const msg  = e.dataset.message || '';
            let visible = true;

            if (filterKind !== null) {
                visible = (kind === filterKind);
            } else if (filterTag !== null) {
                visible = (tag === filterTag);
            } else if (filterText !== null) {
                visible = msg.indexOf(filterText) !== -1;
            }

            e.style.display = visible ? '' : 'none';
        });
    }

    logFilterEl.addEventListener('input', applyLogFilter);

    clearLogBtn.addEventListener('click', () => {
        while (logEl.firstChild) {
            logEl.removeChild(logEl.firstChild);
        }
    });

    // ==== Connection & eval ====

    function setStatus(text, color) {
        statusTxt.textContent = text;
        if (color) statusTxt.style.color = color;
    }

    function saveUrl() {
        try {
            localStorage.setItem(STORAGE_KEY_URL, urlEl.value);
        } catch {}
    }

    function loadUrl() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY_URL);
            if (stored) urlEl.value = stored;
        } catch {}
    }

    function saveCode() {
        try {
            localStorage.setItem(STORAGE_KEY_CODE, codeEl.value);
        } catch {}
    }

    function loadCode() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY_CODE);
            if (stored) codeEl.value = stored;
        } catch {}
    }

    loadUrl();
    loadCode();

    urlEl.addEventListener('change', saveUrl);
    urlEl.addEventListener('blur', saveUrl);
    codeEl.addEventListener('blur', saveCode);

    connectBtn.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
            return;
        }
        ws = new WebSocket(urlEl.value);
        setStatus('Connecting…', 'var(--status-connecting)');
        saveUrl();

        ws.onopen = () => {
            appendLogEntry('text', 'hello', '[connected]');
            connectBtn.textContent = 'Disconnect';
            setStatus('Connected', 'var(--status-connected)');
        };
        ws.onclose = () => {
            appendLogEntry('text', 'hello', '[disconnected]');
            connectBtn.textContent = 'Connect';
            setStatus('Disconnected', 'var(--status-error)');
        };
        ws.onerror = (e) => {
            appendLogEntry('text', 'hello', '[error] ' + e);
            setStatus('Error', 'var(--status-error)');
        };
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                if (msg.op === 'hello') {
                    appendLogEntry('text', 'hello', msg.message + ' (mod: ' + msg.modId + ', port: ' + msg.port + ')');
                } else if (msg.op === 'log') {
                    const m = msg.message || '';
                    const trimmed = m.trim();
                    if ((trimmed.startsWith('{') && trimmed.endsWith('}')) ||
                        (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                        appendLogEntry('json', 'json', m);
                    } else {
                        appendLogEntry('text', 'log', m);
                    }
                } else if (msg.op === 'evalResult') {
                    if (msg.ok) {
                        resultEl.textContent = 'OK:\nValue: ' + msg.value + '\nType: ' + msg.type;
                    } else {
                        resultEl.textContent = 'ERROR: ' + msg.error;
                    }
                } else {
                    appendLogEntry('text', 'log', event.data);
                }
            } catch {
                appendLogEntry('text', 'log', event.data);
            }
        };
    };

    function sendEval() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('Not connected');
            return;
        }
        const code = codeEl.value;
        saveCode();
        ws.send(JSON.stringify({ op: 'eval', code }));
    }

    evalBtn.onclick = sendEval;

    codeEl.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            sendEval();
        }
    });
</script>
</body>
</html>
