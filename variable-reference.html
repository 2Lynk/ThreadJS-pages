<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Variable Reference - ThreadJS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared global stylesheet -->
  <link rel="stylesheet" href="https://2lynk.github.io/stylesheet.css">
  
  <!-- YAML parsing library -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <style>
    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --text-primary: #1a1d20;
      --text-secondary: #495057;
      --border-light: #dee2e6;
      --border-medium: #adb5bd;
      --accent: #6c757d;
      --accent-hover: #495057;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Version bar under header */
    .version-bar {
      padding: 0.5rem 2rem;
      background: #f1f3f5;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .version-bar label {
      font-weight: 500;
    }

    .version-select {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      border: 1px solid var(--border-medium);
      background: var(--bg-secondary);
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .version-note {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    main {
      height: calc(100vh - 120px);
      display: flex;
      padding: 0;
    }

    #sidebar {
      width: 220px;
      background: #f8f9fa;
      border-right: 1px solid var(--border-light);
      padding: 1rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
    }

    #sidebar h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      margin: 0 0 0.5rem;
    }

    #category-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    #category-list > li {
      margin: 0;
      border-radius: 10px;
      padding: 0.1rem 0.2rem;
    }

    #category-list > li.active-category {
      background: var(--accent);
      box-shadow: var(--shadow-sm);
    }

    .category-link {
      display: block;
      padding: 0.32rem 0.65rem;
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }

    .category-link:hover {
      background: #e9ecef;
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    #category-list > li.active-category > .category-link {
      background: transparent;
      color: #ffffff;
      font-weight: 600;
    }

    /* Nested variable list under each category */
    .category-var-list {
      list-style: none;
      margin: 0.35rem 0 0.1rem;
      padding: 0;
      display: none;
      flex-direction: column;
      gap: 0.2rem;
    }

    #category-list li.active-category .category-var-list {
      display: flex;
    }

    .category-var-list li {
      margin: 0;
    }

    .category-var-link {
      width: 100%;
      text-align: left;
      border-radius: 8px;
      border: 1px solid var(--border-light);
      padding: 0.25rem 0.5rem;
      background: #ffffff;
      font-size: 0.82rem;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
      display: block;
      text-decoration: none;
      font-family: "Fira Code", monospace;
    }

    .category-var-link:hover {
      background: #f1f3f5;
      border-color: var(--accent);
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    #content-panel {
      flex: 1;
      background: var(--bg-secondary);
      padding: 1.25rem 1.75rem 1.75rem;
      overflow-y: auto;
    }

    .intro {
      max-width: 760px;
      margin-bottom: 1.5rem;
      background: #e7f5ff;
      border-left: 4px solid #1971c2;
      padding: 1rem 1.25rem;
      border-radius: 6px;
    }

    .intro h2 {
      margin-top: 0;
      color: #1971c2;
      font-size: 1.1rem;
    }

    .intro p {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .intro code {
      background: #fff;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      font-size: 0.85rem;
    }

    .category-section {
      margin-bottom: 2rem;
    }

    .category-section h2 {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 0.25rem;
      color: var(--text-primary);
    }

    .category-section > p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .var-card {
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: #ffffff;
      padding: 0.9rem 1rem;
      margin-bottom: 0.85rem;
      box-shadow: var(--shadow-sm);
    }

    .var-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .var-name {
      font-weight: 600;
      font-size: 1rem;
      font-family: "Fira Code", monospace;
      color: var(--text-primary);
    }

    .var-type-badge {
      font-size: 0.75rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #e9ecef;
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
      white-space: nowrap;
    }

    .var-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }

    .properties-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      overflow: hidden;
    }

    .properties-list li {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      background: #fafbfc;
    }

    .properties-list li:last-child {
      border-bottom: none;
    }

    .prop-name {
      font-family: "Fira Code", monospace;
      color: #1971c2;
      font-weight: 600;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .prop-type {
      font-size: 0.75rem;
      color: #868e96;
      flex-shrink: 0;
      background: #e9ecef;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
    }

    .prop-desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .example-box {
      background: #212529;
      color: #f8f9fa;
      padding: 0.9rem;
      border-radius: 6px;
      margin-top: 0.75rem;
      font-family: "Fira Code", monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      border: 1px solid #343a40;
    }

    .example-box .comment {
      color: #6c757d;
    }

    .example-box .keyword {
      color: #ff6b6b;
    }

    .example-box .string {
      color: #51cf66;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      main {
        flex-direction: column;
        height: auto;
      }

      #sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-light);
        max-height: 200px;
      }

      #content-panel {
        padding: 1rem;
      }

      .properties-list li {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div style="display:flex; align-items:center; gap:0.75rem;">
        <a href="../" class="brand">
          <div class="brand-mark">T</div>
          <div class="brand-labels">
            <div class="brand-text-main">ThreadJS</div>
            <div class="brand-text-sub">Minecraft JS scripting</div>
          </div>
        </a>
        <a class="nav-pill" href="https://2lynk.github.io/">Lynk</a>
      </div>

      <nav class="nav-links">
        <a class="nav-pill" href="index.html">API Reference</a>
        <a class="nav-pill" href="inspector.html">Inspector</a>
        <a class="nav-pill" href="example-mods.html">Example Mods</a>
        <a class="nav-pill" href="designer.html">Designer</a>
        <a class="nav-pill nav-pill--accent" href="variable-reference.html">Variables</a>
      </nav>
    </div>
  </header>

  <!-- Version bar -->
  <div class="version-bar">
    <label for="versionSelectVar">Version:</label>
    <select id="versionSelectVar" class="version-select"></select>
    <span id="versionNoteVar" class="version-note"></span>
  </div>

  <main>
    <!-- Sidebar with categories and variable navigation -->
    <aside id="sidebar">
      <h2>Categories</h2>
      <ul id="category-list">
        <!-- Generated by JavaScript -->
      </ul>
    </aside>

    <!-- Main content panel -->
    <section id="content-panel">
      <div class="intro">
        <h2>ðŸ’¡ How to Use Variables in the Designer</h2>
        <p><strong>Direct Reference:</strong> Use <code>$variableName</code> to reference a variable directly</p>
        <p style="margin-left: 1rem;">Example: <code>"$player"</code> becomes <code>player</code></p>
        
        <p style="margin-top: 0.75rem;"><strong>Template Strings:</strong> Use <code>${variable.property}</code> to embed values in text</p>
        <p style="margin-left: 1rem;">Example: <code>"Welcome ${player.name}!"</code> becomes <code>`Welcome ${player.name}!`</code></p>
        
        <p style="margin-top: 0.75rem;"><strong>Autocomplete:</strong> Start typing in the Parameters JSON field and press Tab or Enter to complete</p>
      </div>

      <div id="variables-content">
        <!-- Content will be generated by JavaScript -->
      </div>
    </section>
  </main>

  <script src="version.js"></script>
  <script>
    // Load variable schemas from versioned YAML files
    let currentVariableData = null;

    async function loadVariableSchema(yamlPath) {
      try {
        const response = await fetch(yamlPath);
        const yamlText = await response.text();
        const data = jsyaml.load(yamlText);
        currentVariableData = data;
        generateReferencePage(data);
      } catch (error) {
        console.error('Error loading variable schema:', error);
        document.getElementById('variables-content').innerHTML = 
          '<div style="color: red; padding: 2rem;">Error loading variable definitions. Please refresh the page.</div>';
      }
    }

    // Generate the reference page content
    function generateReferencePage(data) {
      if (!data || !data.categories) {
        console.error('Invalid variable data:', data);
        return;
      }
      
      // Build variables lookup for extends
      const allVariables = {};
      for (const category of data.categories) {
        for (const variable of category.variables) {
          allVariables[variable.name] = variable;
        }
      }

      // Generate sidebar
      generateSidebar(data, allVariables);
      
      // Generate content
      generateContent(data, allVariables);
      
      // Setup click handlers for sidebar navigation
      setupSidebarNavigation();
    }

    function generateSidebar(data, allVariables) {
      const categoryList = document.getElementById('category-list');
      let html = '';

      data.categories.forEach((category, catIndex) => {
        const categoryId = category.name.toLowerCase().replace(/\s+/g, '-');
        const isFirst = catIndex === 0;
        
        html += `<li class="${isFirst ? 'active-category' : ''}" data-category="${categoryId}">`;
        html += `<a class="category-link" href="#${categoryId}">${category.name}</a>`;
        html += `<ul class="category-var-list">`;
        
        category.variables.forEach(variable => {
          const varId = `var-${variable.name.replace(/\./g, '-')}`;
          html += `<li>`;
          html += `<a class="category-var-link" href="#${varId}">${variable.name}</a>`;
          html += `</li>`;
        });
        
        html += `</ul>`;
        html += `</li>`;
      });

      categoryList.innerHTML = html;
    }

    function generateContent(data, allVariables) {
      const container = document.getElementById('variables-content');
      let html = '';

      for (const category of data.categories) {
        const categoryId = category.name.toLowerCase().replace(/\s+/g, '-');
        
        html += `<div class="category-section" id="${categoryId}">`;
        html += `<h2>${category.name}</h2>`;
        if (category.description) {
          html += `<p>${category.description}</p>`;
        }

        for (const variable of category.variables) {
          const varId = `var-${variable.name.replace(/\./g, '-')}`;
          
          // Handle extends
          let properties = variable.properties || [];
          if (variable.extends) {
            const baseVariable = allVariables[variable.extends];
            if (baseVariable && baseVariable.properties) {
              properties = [...baseVariable.properties, ...properties];
            }
          }

          html += `<div class="var-card" id="${varId}">`;
          html += `<div class="var-header">`;
          html += `<span class="var-name">${variable.name}</span>`;
          if (variable.type) {
            html += `<span class="var-type-badge">${variable.type}</span>`;
          }
          html += `</div>`;
          
          if (variable.description) {
            html += `<div class="var-desc">${variable.description}</div>`;
          }

          if (properties.length > 0) {
            html += '<ul class="properties-list">';
            for (const prop of properties) {
              const fullPath = prop.name.startsWith('[') ? `${variable.name}${prop.name}` : `${variable.name}.${prop.name}`;
              html += '<li>';
              html += `<span class="prop-name">${fullPath}</span>`;
              if (prop.type) html += `<span class="prop-type">${prop.type}</span>`;
              if (prop.description) html += `<span class="prop-desc">${prop.description}</span>`;
              html += '</li>';
            }
            html += '</ul>';
          }

          // Add examples if provided
          if (variable.examples && variable.examples.length > 0) {
            for (const example of variable.examples) {
              html += `<div class="example-box">`;
              if (example.label) {
                html += `<span class="comment">// ${example.label}</span>\n`;
              }
              html += example.code.trim();
              html += `</div>`;
            }
          }

          html += `</div>`;
        }

        html += `</div>`;
      }

      container.innerHTML = html;
    }

    function setupSidebarNavigation() {
      // Category links
      document.querySelectorAll('.category-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const categoryId = link.closest('li').dataset.category;
          
          // Update active category
          document.querySelectorAll('#category-list > li').forEach(li => {
            li.classList.remove('active-category');
          });
          link.closest('li').classList.add('active-category');
          
          // Scroll to category
          const categoryEl = document.getElementById(categoryId);
          if (categoryEl) {
            categoryEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });

      // Variable links
      document.querySelectorAll('.category-var-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const varId = link.getAttribute('href').substring(1);
          const varEl = document.getElementById(varId);
          if (varEl) {
            varEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });

      // Update active category on scroll
      const contentPanel = document.getElementById('content-panel');
      const categoryElements = Array.from(document.querySelectorAll('.category-section'));
      
      contentPanel.addEventListener('scroll', () => {
        const scrollPos = contentPanel.scrollTop + 100;
        
        for (let i = categoryElements.length - 1; i >= 0; i--) {
          const section = categoryElements[i];
          if (section.offsetTop <= scrollPos) {
            const categoryId = section.id;
            
            document.querySelectorAll('#category-list > li').forEach(li => {
              li.classList.remove('active-category');
            });
            
            const activeLi = document.querySelector(`#category-list li[data-category="${categoryId}"]`);
            if (activeLi) {
              activeLi.classList.add('active-category');
            }
            break;
          }
        }
      });
    }

    // Initialize version selector
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initVariableReference);
    } else {
      initVariableReference();
    }

    function initVariableReference() {
      if (window.ThreadJsVersion && window.ThreadJsVersion.initSelector) {
        ThreadJsVersion.initSelector({
          selectId: "versionSelectVar",
          noteId: "versionNoteVar",
          filePattern: /^v[\d.]+\-variables\.(yaml|yml)$/,
          onReady(entry) {
            loadVariableSchema(entry.yamlPath);
          },
          onChange(entry) {
            loadVariableSchema(entry.yamlPath);
          }
        });
      } else {
        // Fallback: load default version
        loadVariableSchema('versions/v1.0.0-variables.yaml');
      }
    }
  </script>
</body>
</html>
